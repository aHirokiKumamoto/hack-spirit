#!/usr/bin/env node

'use strict';

let program    = require('commander');
let moment     = require('moment');
let prompt     = require('prompt');
let colors     = require('colors/safe');
let HackSpirit = require('../lib/hack-spirit');

prompt.message   = '';
prompt.delimiter = '';

let w = colors.white;

program
  .version('0.0.3')
  .option('-u, --user [String]', 'user name')
  .option('-p, --password [String]', 'password')
  .option('-v, --verbose', 'print log')
  .option('-b, --browser', 'show browser');

program
  .command('login')
  .description('login with your team sprint credentials')
  .action(() => {
    if (program.user && program.password) {
      let hackSpirit = new HackSpirit(program.browser, program.verbose);
      hackSpirit.login(program.user, program.password)
      return
    }
    let schema = {
      properties: {
              user: { required: true, description: w('User:') },
          password: { required: true, description: w('Password'), hidden: true }
      }
    };
    console.log('Enter your team spirit credentials.')
    prompt.start()
    prompt.get(schema, function (error, result) {
      if (error) {
         console.log('Sorry, something wrong: ' + error);
         return;
      }
      let hackSpirit = new HackSpirit(program.browser, program.verbose);
      hackSpirit.login(result.user, result.password)
    });
  });
program
  .command('work_status')
  .description('print current work status')
  .action(() => {
    let hackSpirit = new HackSpirit(program.browser, program.verbose);
    hackSpirit.printWorkStatus(program.user, program.password);
  });
program
  .command('start_work')
  .description('start work')
  .action(() => {
      let hackSpirit = new HackSpirit(program.browser, program.verbose);
      hackSpirit.startWork(program.user, program.password);
  });

program
  .command('finish_work')
  .description('finish_work')
  .action(() => {
      let hackSpirit = new HackSpirit(program.browser, program.verbose);
      hackSpirit.finishWork(program.user, program.password);
  });


let datetimeFormat = 'YYYYMMDDHHmm';
let dateFormat     = 'YYYYMMDD';
let defaultNote    = ''
program
  .command('overtime')
  .description('Ask for overtime')
  .option(`-d, --datetime [${datetimeFormat}]`, 'What time you want to finish work (default: current time)')
  .option('-n, --note [String]', `Note of the application (default: "${defaultNote}")`)
  .action((opts) => {
      let date = opts.datetime ? moment(opts.datetime, datetimeFormat).toDate() : new Date();
      let note = opts.note ? opts.note : defaultNote;
      let HackSpirit = require('../lib/hack-spirit');

      let hackSpirit = new HackSpirit(program.browser, program.verbose);
      hackSpirit.askForOvertime(program.user, program.password, date, note);
  });

program
  .command('worktime')
  .description('Record worktime')
  .option(`-d, --date [${dateFormat}]`, 'What day you want to record your worktime .(default: today)')
  .action((opts) => {
      let date = opts.date ? moment(opts.date, dateFormat).toDate() : new Date();
      let HackSpirit = require('../lib/hack-spirit');
      let hackSpirit = new HackSpirit(program.browser, program.verbose);
      hackSpirit.recordWorkTime(program.user, program.password, date);
  });


program
  .command('*', '', { noHelp: true})
  .action(() => {
    program.outputHelp();
  });

program.parse(process.argv);

if (!process.argv.slice(2).length) {
  program.outputHelp();
}